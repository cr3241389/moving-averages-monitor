<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Moving Averages Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        .chart-container {
            position: relative;
            height: 70vh;
            width: 100%;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .info-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .info-label {
            font-weight: bold;
            color: #555;
            font-size: 12px;
        }
        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .density-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .dense {
            background-color: #d4edda;
            color: #155724;
        }
        .spread {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bitcoin Moving Averages Monitor</h1>
            <p>Real-time visualization of EMA and SMA indicators</p>
        </div>
        
        <div class="controls">
            <select id="symbolSelect">
                <option value="BTCUSDT">BTC/USDT</option>
                <option value="ETHUSDT">ETH/USDT</option>
                <option value="BNBUSDT">BNB/USDT</option>
                <option value="SOLUSDT">SOL/USDT</option>
            </select>
            <select id="intervalSelect">
                <option value="1m">1 Minute</option>
                <option value="5m">5 Minutes</option>
                <option value="15m">15 Minutes</option>
                <option value="30m">30 Minutes</option>
                <option value="1h" selected>1 Hour</option>
                <option value="4h">4 Hours</option>
                <option value="1d">1 Day</option>
            </select>
            <button onclick="fetchData()">Refresh Data</button>
            <button onclick="toggleAutoRefresh()">Auto Refresh: <span id="autoStatus">OFF</span></button>
        </div>
        
        <div id="densityStatus" class="density-status spread">MA Status: SPREAD OUT</div>
        
        <div class="chart-container">
            <canvas id="maChart"></canvas>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="color-box" style="background-color: #FF6384;"></div>
                <span>EMA 20</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background-color: #36A2EB;"></div>
                <span>EMA 60</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background-color: #FFCD56;"></div>
                <span>EMA 120</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background-color: #4BC0C0;"></div>
                <span>SMA 20</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background-color: #9966FF;"></div>
                <span>SMA 60</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background-color: #FF9F40;"></div>
                <span>SMA 120</span>
            </div>
        </div>
        
        <div class="info-panel">
            <h3>Current Values</h3>
            <div class="info-grid" id="infoGrid">
                <!-- Dynamic info items will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let chart = null;
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let currentData = null;

        // Initialize the chart
        function initChart() {
            const ctx = document.getElementById('maChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'EMA 20',
                            data: [],
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'EMA 60',
                            data: [],
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'EMA 120',
                            data: [],
                            borderColor: '#FFCD56',
                            backgroundColor: 'rgba(255, 205, 86, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'SMA 20',
                            data: [],
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'SMA 60',
                            data: [],
                            borderColor: '#9966FF',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'SMA 120',
                            data: [],
                            borderColor: '#FF9F40',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price (USDT)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // We're using custom legend
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // Calculate EMA
        function calculateEMA(data, period) {
            if (data.length < period) return null;
            
            const k = 2 / (period + 1);
            let ema = data.slice(0, period).reduce((sum, val) => sum + val, 0) / period;
            
            for (let i = period; i < data.length; i++) {
                ema = data[i] * k + ema * (1 - k);
            }
            
            return ema;
        }

        // Calculate SMA
        function calculateSMA(data, period) {
            if (data.length < period) return null;
            
            const sum = data.slice(-period).reduce((sum, val) => sum + val, 0);
            return sum / period;
        }

        // Calculate standard deviation to check density
        function calculateStdDev(values) {
            const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((sum, val) => sum + val, 0) / values.length;
            return Math.sqrt(avgSquareDiff);
        }

        // Check if MAs are in dense alignment
        function isDenseAlignment(maValues, tolerancePercent = 2.0) {
            const values = Object.values(maValues).filter(v => v !== null);
            if (values.length === 0) return false;
            
            const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
            const stdDev = calculateStdDev(values);
            const stdDevPercent = (stdDev / avg) * 100;
            
            return stdDevPercent <= tolerancePercent;
        }

        // Fetch data from Binance API
        async function fetchData() {
            const symbol = document.getElementById('symbolSelect').value;
            const interval = document.getElementById('intervalSelect').value;
            
            try {
                // Show loading state
                document.body.style.cursor = 'wait';
                
                // Fetch kline data
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=200`);
                const klines = await response.json();
                
                // Process kline data
                const labels = [];
                const prices = [];
                
                for (const kline of klines) {
                    const openTime = new Date(parseInt(kline[0])).toLocaleTimeString();
                    labels.push(openTime);
                    prices.push(parseFloat(kline[4])); // Close price
                }
                
                // Calculate moving averages for each point
                const ema20Data = [];
                const ema60Data = [];
                const ema120Data = [];
                const sma20Data = [];
                const sma60Data = [];
                const sma120Data = [];
                
                for (let i = 0; i < prices.length; i++) {
                    const subPrices = prices.slice(0, i + 1);
                    
                    // Calculate EMAs
                    const ema20 = i >= 19 ? calculateEMA(subPrices, 20) : null;
                    const ema60 = i >= 59 ? calculateEMA(subPrices, 60) : null;
                    const ema120 = i >= 119 ? calculateEMA(subPrices, 120) : null;
                    
                    // Calculate SMAs
                    const sma20 = i >= 19 ? calculateSMA(subPrices, 20) : null;
                    const sma60 = i >= 59 ? calculateSMA(subPrices, 60) : null;
                    const sma120 = i >= 119 ? calculateSMA(subPrices, 120) : null;
                    
                    ema20Data.push(ema20);
                    ema60Data.push(ema60);
                    ema120Data.push(ema120);
                    sma20Data.push(sma20);
                    sma60Data.push(sma60);
                    sma120Data.push(sma120);
                }
                
                // Update chart data
                chart.data.labels = labels;
                chart.data.datasets[0].data = ema20Data;
                chart.data.datasets[1].data = ema60Data;
                chart.data.datasets[2].data = ema120Data;
                chart.data.datasets[3].data = sma20Data;
                chart.data.datasets[4].data = sma60Data;
                chart.data.datasets[5].data = sma120Data;
                
                chart.update();
                
                // Store current data for info panel
                currentData = {
                    ema20: ema20Data[ema20Data.length - 1],
                    ema60: ema60Data[ema60Data.length - 1],
                    ema120: ema120Data[ema120Data.length - 1],
                    sma20: sma20Data[sma20Data.length - 1],
                    sma60: sma60Data[sma60Data.length - 1],
                    sma120: sma120Data[sma120Data.length - 1],
                    currentPrice: prices[prices.length - 1]
                };
                
                // Update info panel
                updateInfoPanel();
                
                // Check density status
                const maValues = {
                    ema20: currentData.ema20,
                    ema60: currentData.ema60,
                    ema120: currentData.ema120,
                    sma20: currentData.sma20,
                    sma60: currentData.sma60,
                    sma120: currentData.sma120
                };
                
                const isDense = isDenseAlignment(maValues);
                const densityStatus = document.getElementById('densityStatus');
                densityStatus.textContent = `MA Status: ${isDense ? 'DENSE' : 'SPREAD OUT'}`;
                densityStatus.className = `density-status ${isDense ? 'dense' : 'spread'}`;
                
                document.body.style.cursor = 'default';
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.body.style.cursor = 'default';
                alert('Error fetching data: ' + error.message);
            }
        }

        // Update info panel with current values
        function updateInfoPanel() {
            if (!currentData) return;
            
            const infoGrid = document.getElementById('infoGrid');
            infoGrid.innerHTML = '';
            
            const maData = [
                { label: 'EMA 20', value: currentData.ema20 },
                { label: 'EMA 60', value: currentData.ema60 },
                { label: 'EMA 120', value: currentData.ema120 },
                { label: 'SMA 20', value: currentData.sma20 },
                { label: 'SMA 60', value: currentData.sma60 },
                { label: 'SMA 120', value: currentData.sma120 },
                { label: 'Current Price', value: currentData.currentPrice }
            ];
            
            maData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'info-item';
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'info-label';
                labelDiv.textContent = item.label;
                
                const valueDiv = document.createElement('div');
                valueDiv.className = 'info-value';
                valueDiv.textContent = item.value ? item.value.toFixed(2) : 'N/A';
                
                div.appendChild(labelDiv);
                div.appendChild(valueDiv);
                infoGrid.appendChild(div);
            });
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            document.getElementById('autoStatus').textContent = isAutoRefresh ? 'ON' : 'OFF';
            
            if (isAutoRefresh) {
                autoRefreshInterval = setInterval(fetchData, 30000); // Refresh every 30 seconds
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // Initialize when page loads
        window.onload = function() {
            initChart();
            fetchData(); // Load initial data
        };
    </script>
</body>
</html>